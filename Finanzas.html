<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Personales PWA</title>
    <style>
        /* ESTILOS (CSS) */
        :root { 
            --primary: #2563eb; 
            --success: #16a34a; 
            --danger: #dc2626; 
            --warning: #f59e0b; 
            --bg: #f3f4f6; 
            --card: #ffffff; 
            --cash: #1e3a8a; /* Azul Oscuro para Efectivo */
            --bank: #facc15; /* Amarillo para Banco */
            --transfer: #8b5cf6; /* Morado para Transferencia */
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: #333; }
        
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        /* Tarjetas y Inputs */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .input-group { display: flex; gap: 10px; }

        /* Saldo Principal */
        .balance-card { text-align: center; padding: 25px; background: var(--primary); color: white; border-radius: 12px; }
        .balance-amount { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .balance-label { opacity: 0.8; }

        /* Tarjetas de Resumen */
        .summary-card { padding: 15px; border-radius: 10px; color: white; flex: 1; text-align: center; margin: 0 5px; }
        .income { background: var(--success); }
        .expense { background: var(--danger); }
        .summary-value { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        /* Botones de Acci√≥n */
        .btn { border: none; padding: 12px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-income { background: var(--success); color: white; }
        .btn-expense { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: white; }

        /* Navegaci√≥n */
        nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        nav button { background: none; color: #999; border: none; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; padding: 5px; cursor: pointer; }
        nav button.active { color: var(--primary); }
        nav button span { font-size: 1.4rem; margin-bottom: 3px; }

        /* Etiquetas */
        .debt-card { border-left: 5px solid var(--danger); }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 8px; }
        .tag-cash { background: var(--cash); color: white; }
        .tag-bank { background: var(--bank); color: black; }
    </style>
</head>
<body>

    <header>
        <h1 id="page-title">Resumen Financiero</h1>
    </header>

    <div id="tab-home" class="container active">
        
        <div class="balance-card">
            <div class="balance-label">SALDO TOTAL DISPONIBLE</div>
            <div class="balance-amount">$<span id="total-balance">0.00</span></div>
            <p style="font-size:0.9rem; opacity:0.9; margin:10px 0 0 0;">(Efectivo: $<span id="cash-balance">0.00</span> | Banco: $<span id="bank-balance">0.00</span>)</p>
        </div>

        <div class="flex-row" style="margin-bottom:15px;">
            <div class="summary-card income">
                <div>üí∞ Ganado</div>
                <div class="summary-value">$<span id="total-income">0.00</span></div>
            </div>
            <div class="summary-card expense">
                <div>üí∏ Gastado</div>
                <div class="summary-value">$<span id="total-expense">0.00</span></div>
            </div>
        </div>

        <h3 style="margin-bottom:5px;">üìã Deudas y Pagos Pendientes</h3>
        <div id="debt-list">
            <p style="text-align:center; color:#666;">No hay deudas activas registradas.</p>
        </div>
    </div>

    <div id="tab-register" class="container">
        <div class="card">
            <h3>üìà Registrar Movimiento</h3>

            <select id="movement-type" onchange="toggleFormFields()">
                <option value="income">Ganancia (Ingreso)</option>
                <option value="expense">Gasto (Egreso)</option>
                <option value="transfer">Transferencia Interna</option>
                <option value="register-debt">Registrar Nueva Deuda/Pr√©stamo</option>
            </select>
            
            <div id="standard-fields">
                <input type="number" id="mov-amount" placeholder="Monto ($)" min="0">
                
                <div id="account-selector">
                    <select id="mov-account">
                        <option value="cash">Efectivo</option>
                        <option value="bank">Cuenta Bancaria</option>
                    </select>
                </div>
                
                <div id="transfer-selectors" style="display:none;">
                    <label style="font-size:0.9rem; display:block; margin-bottom:5px;">De:</label>
                    <select id="transfer-from">
                        <option value="cash">Efectivo</option>
                        <option value="bank">Cuenta Bancaria</option>
                    </select>

                    <label style="font-size:0.9rem; display:block; margin-bottom:5px;">A:</label>
                    <select id="transfer-to">
                        <option value="bank">Cuenta Bancaria</option>
                        <option value="cash">Efectivo</option>
                    </select>
                </div>

                <input type="text" id="mov-description" placeholder="Descripci√≥n (ej. Venta, Alquiler, Dep√≥sito)">
            </div>
            
            <div id="debt-fields" style="display:none; border-top:1px dashed #ddd; margin-top:10px; padding-top:10px;">
                <h4 style="margin-top:0;">Detalles de Deuda/Pr√©stamo</h4>
                
                <input type="text" id="debt-name" placeholder="Nombre de la Deuda/Pr√©stamo">
                
                <select id="debt-status">
                    <option value="loan-active">Pr√©stamo Activo (Me deben)</option>
                    <option value="debt-due">Deuda/Tarjeta de Cr√©dito (Debo)</option>
                </select>

                <input type="number" id="debt-original-amount" placeholder="Monto Original de la Deuda/Pr√©stamo ($)">

                <button onclick="addDebt()" class="btn btn-primary">‚úÖ Registrar Deuda</button>
            </div>

            <button onclick="handleMovement()" class="btn btn-primary" id="mov-btn">üíæ Registrar Movimiento</button>

            <h4 style="margin-top:20px;">Historial de Movimientos (√öltimos 5)</h4>
            <div id="history-list">
                <p style="font-size:0.9rem; color:#666;">No hay movimientos recientes.</p>
            </div>
        </div>
    </div>

    <div id="tab-debts" class="container">
        <h3>üè¶ Gesti√≥n de Pr√©stamos y Deudas</h3>
        <div id="debt-management-list">
            <p style="text-align:center; color:#666;">Aqu√≠ aparecer√°n las deudas para pagar o los pr√©stamos para cobrar.</p>
        </div>
    </div>


    <nav>
        <button onclick="switchTab('home')" id="nav-home" class="nav-btn active">
            <span>üè†</span>Inicio
        </button>
        <button onclick="switchTab('register')" id="nav-register" class="nav-btn">
            <span>‚ûï</span>Registrar
        </button>
        <button onclick="switchTab('debts')" id="nav-debts" class="nav-btn">
            <span>üí≥</span>Deudas
        </button>
    </nav>

    <script>
        // --- BASE DE DATOS LOCAL ---
        let balances = JSON.parse(localStorage.getItem('financesBalances')) || {
            cash: 0,
            bank: 0,
            totalIncome: 0,
            totalExpense: 0
        };
        let movements = JSON.parse(localStorage.getItem('financesMovements')) || [];
        let debts = JSON.parse(localStorage.getItem('financesDebts')) || [];

        function saveLocal() {
            localStorage.setItem('financesBalances', JSON.stringify(balances));
            localStorage.setItem('financesMovements', JSON.stringify(movements));
            localStorage.setItem('financesDebts', JSON.stringify(debts));
            render();
        }

        // --- RENDERIZADO (DIBUJAR PANTALLA) ---
        function render() {
            updateHomeUI();
            updateHistoryList();
            renderDebtLists();
        }

        function updateHomeUI() {
            const total = balances.cash + balances.bank;
            document.getElementById('total-balance').innerText = total.toFixed(2);
            document.getElementById('cash-balance').innerText = balances.cash.toFixed(2);
            document.getElementById('bank-balance').innerText = balances.bank.toFixed(2);
            document.getElementById('total-income').innerText = balances.totalIncome.toFixed(2);
            document.getElementById('total-expense').innerText = balances.totalExpense.toFixed(2);
        }

        function updateHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            // Mostrar solo los √∫ltimos 5 movimientos
            const recentMovements = movements.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (recentMovements.length === 0) {
                list.innerHTML = '<p style="font-size:0.9rem; color:#666;">No hay movimientos recientes.</p>';
                return;
            }

            recentMovements.forEach(mov => {
                let color = 'var(--danger)'; // Default Gasto
                let sign = '-';
                let movType = 'Gasto';
                let description = mov.description;

                if (mov.type === 'income') {
                    color = 'var(--success)';
                    sign = '+';
                    movType = 'Ingreso';
                } else if (mov.type === 'debt-payment') {
                    color = 'var(--warning)';
                    movType = 'Pago/Cobro Deuda';
                    sign = mov.isDebtPaymentOut ? '-' : '+';
                } else if (mov.type === 'transfer') {
                    color = 'var(--transfer)';
                    movType = 'Transferencia';
                    // Para transferencias, mostramos las dos partes de la transacci√≥n en el historial:
                    const fromAccount = mov.fromAccount === 'cash' ? 'Efectivo' : 'Banco';
                    const toAccount = mov.toAccount === 'cash' ? 'Efectivo' : 'Banco';
                    description = `De ${fromAccount} a ${toAccount}`;
                    // Mostramos solo la transferencia de salida
                    if (mov.fromAccount === 'cash' && mov.toAccount === 'bank') {
                        // Salida de efectivo
                         mov.account = mov.fromAccount;
                    } else if (mov.fromAccount === 'bank' && mov.toAccount === 'cash') {
                        // Salida de banco
                        mov.account = mov.fromAccount;
                    } else {
                        // Si no es un movimiento de efectivo a banco o viceversa, lo ignoramos o manejamos el caso
                        return; 
                    }
                }

                const accountTag = `<span class="tag ${mov.account === 'cash' ? 'tag-cash' : 'tag-bank'}">${mov.account === 'cash' ? 'Efectivo' : 'Banco'}</span>`;

                list.innerHTML += `
                    <div class="card flex-row" style="border-left: 5px solid ${color}; padding:10px;">
                        <div style="flex:1;">
                            <p style="margin:0; font-weight:bold;">${description} ${mov.type !== 'transfer' ? accountTag : ''}</p>
                            <p style="margin:0; font-size:0.8rem; color:#666;">${movType} - ${new Date(mov.date).toLocaleDateString()}</p>
                        </div>
                        <span style="font-weight:bold; color:${color};">${sign}$${mov.amount.toFixed(2)}</span>
                    </div>
                `;
            });
        }

        function renderDebtLists() {
            const homeList = document.getElementById('debt-list');
            const managementList = document.getElementById('debt-management-list');
            
            homeList.innerHTML = '';
            managementList.innerHTML = '';

            const activeDebts = debts.filter(d => d.pendingAmount > 0.01);

            if (activeDebts.length === 0) {
                homeList.innerHTML = '<p style="text-align:center; color:#666;">No hay deudas activas registradas.</p>';
                managementList.innerHTML = '<p style="text-align:center; color:#666;">No hay deudas o pr√©stamos pendientes.</p>';
                return;
            }

            activeDebts.forEach(d => {
                const isDebt = d.status === 'debt-due';
                const color = isDebt ? 'var(--danger)' : 'var(--success)';
                const tagText = isDebt ? 'DEUDA' : 'PR√âSTAMO';
                const actionText = isDebt ? 'Pagar' : 'Cobrar';
                
                const cardHtml = `
                    <div class="card ${isDebt ? 'debt-card' : ''}" style="border-left-color: ${color};">
                        <div class="flex-row" style="align-items:flex-start;">
                            <div style="flex-grow:1;">
                                <h4 style="margin:0;">${d.name} <span class="tag" style="background:${color}; color:white;">${tagText}</span></h4>
                                <p style="margin:5px 0; font-size:0.9rem;">Total: $${d.originalAmount.toFixed(2)}</p>
                                <p style="margin:0; font-weight:bold; color:${isDebt ? 'var(--danger)' : 'var(--success)'};">Pendiente: $${d.pendingAmount.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                homeList.innerHTML += cardHtml; 

                // Lista de gesti√≥n de deudas
                managementList.innerHTML += `
                    <div class="card ${isDebt ? 'debt-card' : ''}" style="border-left-color: ${color};">
                        <div class="flex-row">
                            <div style="flex:1;">
                                <h4 style="margin:0;">${d.name}</h4>
                                <p style="margin:0; font-weight:bold; color:${isDebt ? 'var(--danger)' : 'var(--success)'};">Pendiente: $${d.pendingAmount.toFixed(2)}</p>
                            </div>
                            <button onclick="prepDebtPayment(${d.id})" class="btn-primary" style="background:${color}; width:40%; padding:10px; margin:0;">${actionText}</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- L√ìGICA DE MOVIMIENTOS Y FORMULARIO ---
        
        function toggleFormFields() {
            const type = document.getElementById('movement-type').value;
            const debtFields = document.getElementById('debt-fields');
            const standardFields = document.getElementById('standard-fields');
            const movBtn = document.getElementById('mov-btn');
            const accountSelector = document.getElementById('account-selector');
            const transferSelectors = document.getElementById('transfer-selectors');
            const movAmount = document.getElementById('mov-amount');
            const movDescription = document.getElementById('mov-description');
            
            // Ocultar todo por defecto
            debtFields.style.display = 'none';
            standardFields.style.display = 'block';
            movBtn.style.display = 'block';
            accountSelector.style.display = 'block';
            transferSelectors.style.display = 'none';
            movAmount.disabled = false;
            movDescription.disabled = false;


            if (type === 'register-debt') {
                debtFields.style.display = 'block';
                standardFields.style.display = 'none';
                movBtn.style.display = 'none';
            } else if (type === 'transfer') {
                accountSelector.style.display = 'none';
                transferSelectors.style.display = 'block';
                movBtn.innerText = 'üíæ Registrar Transferencia';
            } else { // income o expense
                movBtn.innerText = type === 'income' ? 'üíæ Registrar Ganancia' : 'üíæ Registrar Gasto';
            }
        }
        
        // Manejador principal del bot√≥n "Registrar Movimiento"
        function handleMovement() {
            const type = document.getElementById('movement-type').value;
            
            if (type === 'income' || type === 'expense') {
                addIncomeExpense();
            } else if (type === 'transfer') {
                addTransfer();
            }
        }
        
        function addIncomeExpense() {
            const type = document.getElementById('movement-type').value;
            const amount = parseFloat(document.getElementById('mov-amount').value);
            const account = document.getElementById('mov-account').value;
            const description = document.getElementById('mov-description').value || (type === 'income' ? 'Ingreso' : 'Gasto');

            if (isNaN(amount) || amount <= 0) {
                alert('Ingresa un monto v√°lido.');
                return;
            }

            const isIncome = type === 'income';

            // 1. Actualizar saldos de cuenta
            if (isIncome) {
                balances[account] += amount;
                balances.totalIncome += amount;
            } else { // expense
                if (balances[account] < amount) {
                    alert(`¬°Saldo insuficiente en ${account === 'cash' ? 'Efectivo' : 'Banco'}! Saldo actual: $${balances[account].toFixed(2)}`);
                    return;
                }
                balances[account] -= amount;
                balances.totalExpense += amount;
            }

            // 2. Registrar movimiento
            movements.push({
                date: new Date().toISOString(),
                type: type,
                amount: amount,
                account: account,
                description: description
            });

            saveLocal();
            // Limpiar campos
            document.getElementById('mov-amount').value = '';
            document.getElementById('mov-description').value = '';
        }

        function addTransfer() {
            const amount = parseFloat(document.getElementById('mov-amount').value);
            const fromAccount = document.getElementById('transfer-from').value;
            const toAccount = document.getElementById('transfer-to').value;
            const description = document.getElementById('mov-description').value || 'Transferencia Interna';

            if (isNaN(amount) || amount <= 0) {
                alert('Ingresa un monto v√°lido.');
                return;
            }

            if (fromAccount === toAccount) {
                alert('Las cuentas de origen y destino deben ser diferentes.');
                return;
            }

            // 1. Verificar saldo de origen
            if (balances[fromAccount] < amount) {
                alert(`¬°Saldo insuficiente en ${fromAccount === 'cash' ? 'Efectivo' : 'Banco'}! Saldo actual: $${balances[fromAccount].toFixed(2)}`);
                return;
            }

            // 2. Ejecutar transferencia
            balances[fromAccount] -= amount;
            balances[toAccount] += amount;

            // 3. Registrar movimiento (solo una entrada para la transferencia)
            movements.push({
                date: new Date().toISOString(),
                type: 'transfer',
                amount: amount,
                fromAccount: fromAccount,
                toAccount: toAccount,
                account: fromAccount, // Usamos fromAccount para mostrar la salida en el historial
                description: description
            });

            saveLocal();
            // Limpiar campos
            document.getElementById('mov-amount').value = '';
            document.getElementById('mov-description').value = '';
        }

        // --- L√ìGICA DE DEUDAS/PR√âSTAMOS ---
        
        function addDebt() {
            const name = document.getElementById('debt-name').value;
            const status = document.getElementById('debt-status').value;
            const originalAmount = parseFloat(document.getElementById('debt-original-amount').value);

            if (!name || isNaN(originalAmount) || originalAmount <= 0) {
                alert('Completa el nombre y el monto original de la deuda.');
                return;
            }

            debts.push({
                id: Date.now(),
                name: name,
                status: status, // 'loan-active' o 'debt-due'
                originalAmount: originalAmount,
                pendingAmount: originalAmount,
                date: new Date().toISOString()
            });

            saveLocal();
            
            // Limpiar campos de deuda y volver a modo de movimiento simple
            document.getElementById('debt-name').value = '';
            document.getElementById('debt-original-amount').value = '';
            document.getElementById('movement-type').value = 'income'; // Resetear selector
            toggleFormFields(); 

            switchTab('debts');
            alert('Deuda/Pr√©stamo registrado.');
        }

        function prepDebtPayment(debtId) {
            const debtIndex = debts.findIndex(d => d.id === debtId);
            if (debtIndex === -1) return;

            const debt = debts[debtIndex];
            const isDebt = debt.status === 'debt-due';
            const action = isDebt ? 'Pagar' : 'Cobrar';
            const transactionType = isDebt ? 'Egreso' : 'Ingreso';
            
            // 1. Solicitar el monto
            const paymentAmountInput = prompt(`Monto a ${action} de "${debt.name}" (Pendiente: $${debt.pendingAmount.toFixed(2)}):`);
            
            if (paymentAmountInput === null) return;
            
            const paymentAmount = parseFloat(paymentAmountInput);

            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Monto inv√°lido. Int√©ntalo de nuevo.');
                return;
            }

            if (paymentAmount > debt.pendingAmount) {
                alert(`El monto excede el saldo pendiente ($${debt.pendingAmount.toFixed(2)}).`);
                return;
            }

            // 2. Solicitar la cuenta
            let account = '';
            while (account !== 'cash' && account !== 'bank') {
                const accountInput = prompt(`¬ø${action} con (escribe 'cash' para Efectivo o 'bank' para Banco)?`).toLowerCase();
                if (accountInput === null) return;
                account = accountInput;
            }
            
            // 3. L√≥gica de saldo:
            let isDebtPaymentOut = false; 
            if (isDebt) {
                // Es DEUDA: Gasto de tu cuenta
                if (balances[account] < paymentAmount) {
                    alert(`¬°Saldo insuficiente en ${account === 'cash' ? 'Efectivo' : 'Banco'} para el pago!`);
                    return;
                }
                balances[account] -= paymentAmount;
                isDebtPaymentOut = true;
            } else { 
                // Es PR√âSTAMO: Ingreso a tu cuenta
                balances[account] += paymentAmount;
                isDebtPaymentOut = false;
            }
            
            // 4. Actualizar deuda
            debts[debtIndex].pendingAmount -= paymentAmount;
            if (debts[debtIndex].pendingAmount < 0.01) {
                 debts[debtIndex].pendingAmount = 0; 
            }

            // 5. Registrar movimiento especial
            movements.push({
                date: new Date().toISOString(),
                type: 'debt-payment',
                amount: paymentAmount,
                account: account,
                description: `${action} de ${debt.name}`,
                isDebtPaymentOut: isDebtPaymentOut
            });

            saveLocal();
            alert(`${transactionType} de $${paymentAmount.toFixed(2)} (${action} de deuda) registrado con √©xito.`);
        }


        // --- NAVEGACI√ìN ---
        function switchTab(tab) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            let titles = { 'home': 'Resumen Financiero', 'register': 'Registrar Movimientos', 'debts': 'Gesti√≥n de Deudas' };
            document.getElementById('page-title').innerText = titles[tab];
        }

        // Iniciar
        toggleFormFields(); 
        render();
    </script>
</body>
</html>

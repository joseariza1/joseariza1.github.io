<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Personales PWA</title>
    <style>
        /* ESTILOS (CSS) */
        :root { 
            --primary: #2563eb; 
            --success: #16a34a; 
            --danger: #dc2626; 
            --warning: #f59e0b; 
            --bg: #f3f4f6; 
            --card: #ffffff; 
            --cash: #1e3a8a; /* Azul Oscuro para Efectivo */
            --bank: #facc15; /* Amarillo para Banco */
            --transfer: #8b5cf6; /* Morado para Transferencia */
            --adjust-add: #22c55e; /* Verde para Sumar Adeudo */
            --adjust-sub: #f97316; /* Naranja para Restar Adeudo */
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: #333; }
        
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        /* Tarjetas y Inputs */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .input-group { display: flex; gap: 10px; }

        /* Saldo Principal */
        .balance-card { text-align: center; padding: 25px; background: var(--primary); color: white; border-radius: 12px; position: relative;}
        .balance-amount { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .balance-label { opacity: 0.8; }
        
        /* Controles de Saldo Detallado */
        .balance-detail { 
            font-size:0.9rem; 
            opacity:0.9; 
            margin:10px 0 0 0; 
            display: flex; 
            justify-content: center;
            gap: 15px;
        }
        .balance-item { 
            display: inline-block; 
            cursor: pointer;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.5);
        }

        /* Tarjetas de Resumen */
        .summary-card { padding: 15px; border-radius: 10px; color: white; flex: 1; text-align: center; margin: 0 5px; }
        .income { background: var(--success); }
        .expense { background: var(--danger); }
        .summary-value { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        /* Botones de Acci√≥n */
        .btn { border: none; padding: 12px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-income { background: var(--success); color: white; }
        .btn-expense { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* Modal General */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        #payment-buttons .btn, #adjust-buttons .btn {
            width: 48%;
            margin-left: 2%;
            margin-right: 2%;
            padding: 10px;
        }
        
        /* Navegaci√≥n */
        nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        nav button { background: none; color: #999; border: none; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; padding: 5px; cursor: pointer; }
        nav button.active { color: var(--primary); }
        nav button span { font-size: 1.4rem; margin-bottom: 3px; }

        /* Etiquetas */
        .debt-card { border-left: 5px solid var(--danger); }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 8px; }
        .tag-cash { background: var(--cash); color: white; }
        .tag-bank { background: var(--bank); color: black; }
    </style>
</head>
<body>

    <header>
        <h1 id="page-title">Resumen Financiero</h1>
    </header>

    <div id="tab-home" class="container active">
        
        <div class="balance-card">
            <div class="balance-label">SALDO TOTAL DISPONIBLE</div>
            <div class="balance-amount">$<span id="total-balance">0.00</span></div>
            <p class="balance-detail">
                <span class="balance-item" onclick="promptEditBalance('cash')">Efectivo: $<span id="cash-balance">0.00</span> ‚úèÔ∏è</span>
                |
                <span class="balance-item" onclick="promptEditBalance('bank')">Banco: $<span id="bank-balance">0.00</span> ‚úèÔ∏è</span>
            </p>
        </div>

        <div class="flex-row" style="margin-bottom:15px;">
            <div class="summary-card income">
                <div>üí∞ Ganado</div>
                <div class="summary-value">$<span id="total-income">0.00</span></div>
            </div>
            <div class="summary-card expense">
                <div>üí∏ Gastado</div>
                <div class="summary-value">$<span id="total-expense">0.00</span></div>
            </div>
        </div>

        <h3 style="margin-bottom:5px;">üìã Deudas y Pagos Pendientes</h3>
        <div id="debt-list">
            <p style="text-align:center; color:#666;">No hay deudas activas registradas.</p>
        </div>
    </div>

    <div id="tab-register" class="container">
        <div class="card">
            <h3>üìà Registrar Movimiento</h3>

            <select id="movement-type" onchange="toggleFormFields()">
                <option value="income">Ganancia (Ingreso)</option>
                <option value="expense">Gasto (Egreso)</option>
                <option value="transfer">Transferencia Interna</option>
                <option value="register-debt">Registrar Nueva Deuda/Pr√©stamo</option>
            </select>
            
            <div id="standard-fields">
                <input type="number" id="mov-amount" placeholder="Monto ($)" min="0">
                
                <div id="account-selector">
                    <select id="mov-account">
                        <option value="cash">Efectivo</option>
                        <option value="bank">Cuenta Bancaria</option>
                    </select>
                </div>
                
                <div id="transfer-selectors" style="display:none;">
                    <label style="font-size:0.9rem; display:block; margin-bottom:5px;">De:</label>
                    <select id="transfer-from">
                        <option value="cash">Efectivo</option>
                        <option value="bank">Cuenta Bancaria</option>
                    </select>

                    <label style="font-size:0.9rem; display:block; margin-bottom:5px;">A:</label>
                    <select id="transfer-to">
                        <option value="bank">Cuenta Bancaria</option>
                        <option value="cash">Efectivo</option>
                    </select>
                </div>

                <input type="text" id="mov-description" placeholder="Descripci√≥n (ej. Venta, Alquiler, Dep√≥sito)">
            </div>
            
            <div id="debt-fields" style="display:none; border-top:1px dashed #ddd; margin-top:10px; padding-top:10px;">
                <h4 style="margin-top:0;">Detalles de Deuda/Pr√©stamo</h4>
                
                <input type="text" id="debt-name" placeholder="Nombre de la Deuda/Pr√©stamo">
                
                <select id="debt-status">
                    <option value="loan-active">Pr√©stamo Activo (Me deben)</option>
                    <option value="debt-due">Deuda/Tarjeta de Cr√©dito (Debo)</option>
                </select>

                <input type="number" id="debt-original-amount" placeholder="Monto Original de la Deuda/Pr√©stamo ($)">

                <button onclick="addDebt()" class="btn btn-primary">‚úÖ Registrar Deuda</button>
            </div>

            <button onclick="handleMovement()" class="btn btn-primary" id="mov-btn">üíæ Registrar Movimiento</button>

            <h4 style="margin-top:20px;">Historial de Movimientos (√öltimos 5)</h4>
            <div id="history-list">
                <p style="font-size:0.9rem; color:#666;">No hay movimientos recientes.</p>
            </div>
        </div>
    </div>

    <div id="tab-debts" class="container">
        <h3>üè¶ Gesti√≥n de Pr√©stamos y Deudas</h3>
        <p style="font-size:0.9rem; color:#666;">**Pago/Cobro:** Afecta tu saldo de efectivo/banco.<br>**Ajustar Saldo:** Modifica solo el saldo pendiente de la deuda.</p>
        <div id="debt-management-list">
            <p style="text-align:center; color:#666;">Aqu√≠ aparecer√°n las deudas para pagar o los pr√©stamos para cobrar.</p>
        </div>
    </div>

    <div id="debt-payment-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="modal-title">Registrar Pago</h4>
            <p style="font-size: 0.9rem; color: #666;" id="modal-debt-info-payment"></p>
            
            <label style="font-size:0.9rem; display:block; margin-bottom:5px;">Monto de la Transacci√≥n ($):</label>
            <input type="number" id="debt-payment-amount" placeholder="Monto">
            
            <div id="payment-buttons" class="flex-row">
                </div>
            
            <button onclick="closeModal('debt-payment-modal')" class="btn btn-expense" style="background: #ccc; color: #333;">Cancelar</button>
        </div>
    </div>
    
    <div id="debt-adjust-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="adjust-modal-title">Ajustar Saldo Pendiente</h4>
            <p style="font-size: 0.9rem; color: #666;" id="modal-debt-info-adjust"></p>
            
            <label style="font-size:0.9rem; display:block; margin-bottom:5px;">Monto a Sumar o Restar ($):</label>
            <input type="number" id="debt-adjust-amount-input" placeholder="Ej: 50.00" value="0.00">
            
            <div id="adjust-buttons" class="flex-row">
                <button class="btn" style="background: var(--adjust-add);" onclick="finalizeDebtAdjustment('add')">‚ûï Sumar al Adeudo</button>
                <button class="btn" style="background: var(--adjust-sub);" onclick="finalizeDebtAdjustment('sub')">‚ûñ Restar del Adeudo</button>
            </div>
            
            <button onclick="closeModal('debt-adjust-modal')" class="btn btn-expense" style="background: #ccc; color: #333;">Cancelar</button>
        </div>
    </div>

    <nav>
        <button onclick="switchTab('home')" id="nav-home" class="nav-btn active">
            <span>üè†</span>Inicio
        </button>
        <button onclick="switchTab('register')" id="nav-register" class="nav-btn">
            <span>‚ûï</span>Registrar
        </button>
        <button onclick="switchTab('debts')" id="nav-debts" class="nav-btn">
            <span>üí≥</span>Deudas
        </button>
    </nav>

    <script>
        // Almacenar temporalmente la deuda que se est√° pagando/ajustando
        let currentDebtId = null;

        // --- BASE DE DATOS LOCAL ---
        let balances = JSON.parse(localStorage.getItem('financesBalances')) || {
            cash: 0,
            bank: 0,
            totalIncome: 0,
            totalExpense: 0
        };
        let movements = JSON.parse(localStorage.getItem('financesMovements')) || [];
        let debts = JSON.parse(localStorage.getItem('financesDebts')) || [];

        function saveLocal() {
            localStorage.setItem('financesBalances', JSON.stringify(balances));
            localStorage.setItem('financesMovements', JSON.stringify(movements));
            localStorage.setItem('financesDebts', JSON.stringify(debts));
            render();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('visible');
        }

        // --- RENDERIZADO (DIBUJAR PANTALLA) ---
        function render() {
            updateHomeUI();
            updateHistoryList();
            renderDebtLists();
        }

        function updateHomeUI() {
            const total = balances.cash + balances.bank;
            document.getElementById('total-balance').innerText = total.toFixed(2);
            document.getElementById('cash-balance').innerText = balances.cash.toFixed(2);
            document.getElementById('bank-balance').innerText = balances.bank.toFixed(2);
            document.getElementById('total-income').innerText = balances.totalIncome.toFixed(2);
            document.getElementById('total-expense').innerText = balances.totalExpense.toFixed(2);
        }

        function updateHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            const recentMovements = movements.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (recentMovements.length === 0) {
                list.innerHTML = '<p style="font-size:0.9rem; color:#666;">No hay movimientos recientes.</p>';
                return;
            }

            recentMovements.forEach(mov => {
                let color = 'var(--danger)';
                let sign = '-';
                let movType = 'Gasto';
                let description = mov.description;
                let accountTag = '';
                
                if (mov.type === 'income') {
                    color = 'var(--success)';
                    sign = '+';
                    movType = 'Ingreso';
                    accountTag = `<span class="tag ${mov.account === 'cash' ? 'tag-cash' : 'tag-bank'}">${mov.account === 'cash' ? 'Efectivo' : 'Banco'}</span>`;
                } else if (mov.type === 'debt-payment') {
                    color = 'var(--warning)';
                    movType = 'Pago/Cobro Deuda';
                    sign = mov.isDebtPaymentOut ? '-' : '+';
                    accountTag = `<span class="tag ${mov.account === 'cash' ? 'tag-cash' : 'tag-bank'}">${mov.account === 'cash' ? 'Efectivo' : 'Banco'}</span>`;
                } else if (mov.type === 'transfer') {
                    color = 'var(--transfer)';
                    movType = 'Transferencia';
                    const fromAccount = mov.fromAccount === 'cash' ? 'Efectivo' : 'Banco';
                    const toAccount = mov.toAccount === 'cash' ? 'Efectivo' : 'Banco';
                    description = `De ${fromAccount} a ${toAccount}`;
                    
                    if (mov.fromAccount !== 'cash' && mov.fromAccount !== 'bank') return;
                    mov.account = mov.fromAccount;
                    accountTag = `<span class="tag ${mov.account === 'cash' ? 'tag-cash' : 'tag-bank'}">Origen: ${mov.account === 'cash' ? 'Efectivo' : 'Banco'}</span>`;
                    sign = '-'; 
                } else if (mov.type === 'debt-adjust') {
                    color = mov.adjustment > 0 ? 'var(--adjust-add)' : 'var(--adjust-sub)';
                    movType = 'Ajuste Deuda';
                    sign = mov.adjustment > 0 ? '+' : '-';
                }


                list.innerHTML += `
                    <div class="card flex-row" style="border-left: 5px solid ${color}; padding:10px;">
                        <div style="flex:1;">
                            <p style="margin:0; font-weight:bold;">${description} ${accountTag}</p>
                            <p style="margin:0; font-size:0.8rem; color:#666;">${movType} - ${new Date(mov.date).toLocaleDateString()}</p>
                        </div>
                        <span style="font-weight:bold; color:${color};">${sign}$${mov.amount.toFixed(2)}</span>
                    </div>
                `;
            });
        }

        function renderDebtLists() {
            const homeList = document.getElementById('debt-list');
            const managementList = document.getElementById('debt-management-list');
            
            homeList.innerHTML = '';
            managementList.innerHTML = '';

            const activeDebts = debts.filter(d => d.pendingAmount > 0.01);

            if (activeDebts.length === 0) {
                homeList.innerHTML = '<p style="text-align:center; color:#666;">No hay deudas activas registradas.</p>';
                managementList.innerHTML = '<p style="text-align:center; color:#666;">No hay deudas o pr√©stamos pendientes.</p>';
                return;
            }

            activeDebts.forEach(d => {
                const isDebt = d.status === 'debt-due';
                const color = isDebt ? 'var(--danger)' : 'var(--success)';
                const tagText = isDebt ? 'DEUDA' : 'PR√âSTAMO';
                const actionText = isDebt ? 'Pagar' : 'Cobrar';
                
                const cardHtml = `
                    <div class="card ${isDebt ? 'debt-card' : ''}" style="border-left-color: ${color};">
                        <div class="flex-row" style="align-items:flex-start;">
                            <div style="flex-grow:1;">
                                <h4 style="margin:0;">${d.name} <span class="tag" style="background:${color}; color:white;">${tagText}</span></h4>
                                <p style="margin:5px 0; font-size:0.9rem;">Total Original: $${d.originalAmount.toFixed(2)}</p>
                                <p style="margin:0; font-weight:bold; color:${isDebt ? 'var(--danger)' : 'var(--success)'};">Pendiente: $${d.pendingAmount.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                homeList.innerHTML += cardHtml; 

                // Lista de gesti√≥n de deudas
                managementList.innerHTML += `
                    <div class="card ${isDebt ? 'debt-card' : ''}" style="border-left-color: ${color};">
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin:0 0 5px 0;">${d.name}</h4>
                            <p style="margin:0; font-weight:bold; color:${isDebt ? 'var(--danger)' : 'var(--success)'};">Pendiente: $${d.pendingAmount.toFixed(2)}</p>
                            <p style="margin:5px 0 10px 0; font-size:0.8rem; color:#999;">Original: $${d.originalAmount.toFixed(2)}</p>
                        </div>
                        
                        <div class="flex-row" style="margin-bottom: 5px; flex-wrap: wrap;">
                            <button onclick="openDebtPaymentModal(${d.id})" class="btn-primary" style="background:${color}; width:100%; padding:10px; margin-top:0; margin-bottom: 5px;">${actionText} (Afecta Saldo Cuentas)</button>
                            <button onclick="openDebtAdjustModal(${d.id})" class="btn-primary" style="background: ${isDebt ? 'var(--adjust-sub)' : 'var(--adjust-add)'}; width:100%; padding:10px; margin-top:0;">+/- Ajuste Manual</button>
                        </div>
                    </div>
                `;
            });
        }
        
        // --- MODIFICACI√ìN DE SALDOS EN L√çNEA ---
        function promptEditBalance(account) {
            const currentBalance = balances[account];
            const accountName = account === 'cash' ? 'Efectivo' : 'Banco';
            
            const newBalanceInput = prompt(`Ingresa el saldo ACTUAL CORRECTO para ${accountName}. Saldo actual: $${currentBalance.toFixed(2)}`);
            
            if (newBalanceInput === null) return;
            
            const newBalance = parseFloat(newBalanceInput);

            if (!isNaN(newBalance) && newBalance >= 0) {
                balances[account] = newBalance;
                saveLocal();
                alert(`Saldo de ${accountName} actualizado a $${newBalance.toFixed(2)}.`);
            } else {
                alert('Monto no v√°lido. El saldo debe ser un n√∫mero positivo.');
            }
        }
        
        // --- PAGOS DE DEUDAS (MODAL Y BOTONES) ---

        function openDebtPaymentModal(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            currentDebtId = debtId;
            const isDebt = debt.status === 'debt-due';
            const action = isDebt ? 'Pagar' : 'Cobrar';
            const buttonColor = isDebt ? 'var(--danger)' : 'var(--success)';

            document.getElementById('modal-title').innerText = `Registrar ${action}`;
            document.getElementById('modal-debt-info-payment').innerText = `${debt.name} - Pendiente: $${debt.pendingAmount.toFixed(2)}`;
            document.getElementById('debt-payment-amount').value = '';
            
            // Configurar botones de pago/cobro
            const paymentButtons = document.getElementById('payment-buttons');
            paymentButtons.innerHTML = `
                <button class="btn" style="background: ${buttonColor};" onclick="finalizeDebtPayment('cash')">${action} con Efectivo ($${balances.cash.toFixed(2)})</button>
                <button class="btn" style="background: ${buttonColor};" onclick="finalizeDebtPayment('bank')">${action} con Banco ($${balances.bank.toFixed(2)})</button>
            `;

            document.getElementById('debt-payment-modal').classList.add('visible');
        }

        function finalizeDebtPayment(account) {
            if (currentDebtId === null) return;

            const debtIndex = debts.findIndex(d => d.id === currentDebtId);
            const debt = debts[debtIndex];
            
            const amountInput = document.getElementById('debt-payment-amount').value;
            const paymentAmount = parseFloat(amountInput);

            closeModal('debt-payment-modal');
            currentDebtId = null; 

            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert('Monto de pago inv√°lido. Por favor, int√©ntalo de nuevo.');
                return;
            }
            if (paymentAmount > debt.pendingAmount) {
                alert(`El monto ($${paymentAmount.toFixed(2)}) excede el saldo pendiente ($${debt.pendingAmount.toFixed(2)}).`);
                return;
            }

            const isDebt = debt.status === 'debt-due';
            const action = isDebt ? 'Pagar' : 'Cobrar';
            let isDebtPaymentOut = false; 

            // L√≥gica de saldo:
            if (isDebt) { // Es DEUDA: Sale dinero de tu cuenta (Gasto)
                if (balances[account] < paymentAmount) {
                    alert(`¬°Saldo insuficiente en ${account === 'cash' ? 'Efectivo' : 'Banco'} para el pago! Saldo: $${balances[account].toFixed(2)}`);
                    return;
                }
                balances[account] -= paymentAmount;
                isDebtPaymentOut = true;
                balances.totalExpense += paymentAmount; // Contabilizar como gasto
            } else { // Es PR√âSTAMO: Entra dinero a tu cuenta (Ingreso)
                balances[account] += paymentAmount;
                isDebtPaymentOut = false;
                balances.totalIncome += paymentAmount; // Contabilizar como ingreso
            }
            
            // Actualizar deuda
            debt.pendingAmount -= paymentAmount;
            if (debt.pendingAmount < 0.01) {
                 debt.pendingAmount = 0; 
            }

            // Registrar movimiento
            movements.push({
                date: new Date().toISOString(),
                type: 'debt-payment',
                amount: paymentAmount,
                account: account,
                description: `${action} de ${debt.name}`,
                isDebtPaymentOut: isDebtPaymentOut
            });

            saveLocal();
            alert(`${action} de $${paymentAmount.toFixed(2)} con ${account === 'cash' ? 'Efectivo' : 'Banco'} registrado con √©xito.`);
        }


        // --- AJUSTE DE ADEUDOS (MODAL Y BOTONES) ---
        
        function openDebtAdjustModal(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            currentDebtId = debtId;

            document.getElementById('adjust-modal-title').innerText = `Ajustar Saldo: ${debt.name}`;
            document.getElementById('modal-debt-info-adjust').innerText = `Saldo Pendiente Actual: $${debt.pendingAmount.toFixed(2)}`;
            document.getElementById('debt-adjust-amount-input').value = '0.00'; 
            
            document.getElementById('debt-adjust-modal').classList.add('visible');
        }

        function finalizeDebtAdjustment(operation) {
            if (currentDebtId === null) return;
            
            const debtIndex = debts.findIndex(d => d.id === currentDebtId);
            const debt = debts[debtIndex];
            
            const inputElement = document.getElementById('debt-adjust-amount-input');
            const inputAmount = parseFloat(inputElement.value);

            closeModal('debt-adjust-modal');
            currentDebtId = null;

            if (isNaN(inputAmount) || inputAmount <= 0) {
                alert('Ingresa un monto positivo v√°lido para el ajuste.');
                return;
            }

            let adjustment = inputAmount;
            
            if (operation === 'sub') {
                adjustment = -adjustment;
            }

            const newPendingAmount = debt.pendingAmount + adjustment;
            
            // VALIDACI√ìN CORREGIDA: Solo impide saldo pendiente negativo.
            if (newPendingAmount < 0) {
                alert('El ajuste resultar√≠a en un saldo pendiente negativo. Se limit√≥ el ajuste para dejar el saldo en $0.');
                adjustment = -debt.pendingAmount; // Calcula el ajuste real para llegar a 0
                debt.pendingAmount = 0;
            } else {
                // AHORA PERMITE QUE EL SALDO PENDIENTE EXCEDA EL MONTO ORIGINAL
                debt.pendingAmount = newPendingAmount;
            }
            
            if (adjustment === 0) {
                 alert('No se realiz√≥ ning√∫n cambio.');
                 return;
            }
            
            // Registrar movimiento
            movements.push({
                date: new Date().toISOString(),
                type: 'debt-adjust',
                amount: Math.abs(adjustment),
                adjustment: adjustment,
                debtId: debt.id,
                description: `Ajuste manual de ${debt.name} (${adjustment > 0 ? 'Aumento' : 'Reducci√≥n'})`
            });


            saveLocal();
            alert(`Saldo pendiente de "${debt.name}" ajustado. Nuevo saldo: $${debt.pendingAmount.toFixed(2)}`);
        }
        
        // --- L√ìGICA DE MOVIMIENTOS GENERALES (Se mantiene igual) ---
        
        function toggleFormFields() {
            const type = document.getElementById('movement-type').value;
            const debtFields = document.getElementById('debt-fields');
            const standardFields = document.getElementById('standard-fields');
            const movBtn = document.getElementById('mov-btn');
            const accountSelector = document.getElementById('account-selector');
            const transferSelectors = document.getElementById('transfer-selectors');
            const movAmount = document.getElementById('mov-amount');
            const movDescription = document.getElementById('mov-description');
            
            debtFields.style.display = 'none';
            standardFields.style.display = 'block';
            movBtn.style.display = 'block';
            accountSelector.style.display = 'block';
            transferSelectors.style.display = 'none';
            movAmount.disabled = false;
            movDescription.disabled = false;


            if (type === 'register-debt') {
                debtFields.style.display = 'block';
                standardFields.style.display = 'none';
                movBtn.style.display = 'none';
            } else if (type === 'transfer') {
                accountSelector.style.display = 'none';
                transferSelectors.style.display = 'block';
                movBtn.innerText = 'üíæ Registrar Transferencia';
            } else { 
                movBtn.innerText = type === 'income' ? 'üíæ Registrar Ganancia' : 'üíæ Registrar Gasto';
            }
        }
        
        function handleMovement() {
            const type = document.getElementById('movement-type').value;
            
            if (type === 'income' || type === 'expense') {
                addIncomeExpense();
            } else if (type === 'transfer') {
                addTransfer();
            }
        }
        
        function addIncomeExpense() {
            const type = document.getElementById('movement-type').value;
            const amount = parseFloat(document.getElementById('mov-amount').value);
            const account = document.getElementById('mov-account').value;
            const description = document.getElementById('mov-description').value || (type === 'income' ? 'Ingreso' : 'Gasto');

            if (isNaN(amount) || amount <= 0) {
                alert('Ingresa un monto v√°lido.');
                return;
            }

            const isIncome = type === 'income';

            if (isIncome) {
                balances[account] += amount;
                balances.totalIncome += amount;
            } else {
                if (balances[account] < amount) {
                    alert(`¬°Saldo insuficiente en ${account === 'cash' ? 'Efectivo' : 'Banco'}! Saldo actual: $${balances[account].toFixed(2)}`);
                    return;
                }
                balances[account] -= amount;
                balances.totalExpense += amount;
            }

            movements.push({
                date: new Date().toISOString(),
                type: type,
                amount: amount,
                account: account,
                description: description
            });

            saveLocal();
            document.getElementById('mov-amount').value = '';
            document.getElementById('mov-description').value = '';
        }

        function addTransfer() {
            const amount = parseFloat(document.getElementById('mov-amount').value);
            const fromAccount = document.getElementById('transfer-from').value;
            const toAccount = document.getElementById('transfer-to').value;
            const description = document.getElementById('mov-description').value || 'Transferencia Interna';

            if (isNaN(amount) || amount <= 0) {
                alert('Ingresa un monto v√°lido.');
                return;
            }

            if (fromAccount === toAccount) {
                alert('Las cuentas de origen y destino deben ser diferentes.');
                return;
            }

            if (balances[fromAccount] < amount) {
                alert(`¬°Saldo insuficiente en ${fromAccount === 'cash' ? 'Efectivo' : 'Banco'}! Saldo actual: $${balances[fromAccount].toFixed(2)}`);
                return;
            }

            balances[fromAccount] -= amount;
            balances[toAccount] += amount;

            movements.push({
                date: new Date().toISOString(),
                type: 'transfer',
                amount: amount,
                fromAccount: fromAccount,
                toAccount: toAccount,
                account: fromAccount, 
                description: description
            });

            saveLocal();
            document.getElementById('mov-amount').value = '';
            document.getElementById('mov-description').value = '';
        }
        
        function addDebt() {
            const name = document.getElementById('debt-name').value;
            const status = document.getElementById('debt-status').value;
            const originalAmount = parseFloat(document.getElementById('debt-original-amount').value);

            if (!name || isNaN(originalAmount) || originalAmount <= 0) {
                alert('Completa el nombre y el monto original de la deuda.');
                return;
            }

            debts.push({
                id: Date.now(),
                name: name,
                status: status, 
                originalAmount: originalAmount,
                pendingAmount: originalAmount,
                date: new Date().toISOString()
            });

            saveLocal();
            
            document.getElementById('debt-name').value = '';
            document.getElementById('debt-original-amount').value = '';
            document.getElementById('movement-type').value = 'income';
            toggleFormFields(); 

            switchTab('debts');
            alert('Deuda/Pr√©stamo registrado.');
        }


        // --- NAVEGACI√ìN ---
        function switchTab(tab) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            let titles = { 'home': 'Resumen Financiero', 'register': 'Registrar Movimientos', 'debts': 'Gesti√≥n de Deudas' };
            document.getElementById('page-title').innerText = titles[tab];
        }

        // Iniciar
        toggleFormFields(); 
        render();
    </script>
</body>
</html>

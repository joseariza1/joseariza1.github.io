<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n Comercial Pro</title>
    <style>
        /* ESTILOS (CSS) */
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; }
        
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        /* Tarjetas */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        
        .product-info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .product-info p { margin: 0; color: #666; font-size: 0.85rem; }
        .stock-badge { background: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        
        /* Botones */
        button { border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-update { background: var(--warning); color: black; width: 100%; margin-top: 10px; display: none; }
        .btn-sell { background: var(--success); color: white; width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; }
        .btn-schedule { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; }
        .btn-icon { background: none; font-size: 1.2rem; padding: 5px 10px; }
        .btn-remove { color: var(--danger); background: #fee2e2; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; }

        /* Inputs */
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        textarea { resize: vertical; }
        .input-group { display: flex; gap: 10px; }

        /* Finanzas Cards */
        .stat-card { text-align: center; padding: 20px; border-radius: 12px; color: white; margin-bottom: 15px; }
        .stat-blue { background: var(--primary); }
        .stat-green { background: var(--success); }
        .stat-red { background: var(--danger); }
        .stat-number { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }

        /* Carrito y Entregas Detalles */
        .item-card { background: #f9fafb; padding: 10px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--danger); }
        .delivery-card.pending { border-left: 5px solid var(--primary); }
        .delivery-card.completed { border-left: 5px solid var(--success); }
        .item-info { font-size: 0.9rem; }

        /* Navegaci√≥n */
        nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        nav button { background: none; color: #999; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; }
        nav button.active { color: var(--primary); }
        nav button span { font-size: 1.4rem; margin-bottom: 3px; }

        .editing-mode-indicator { background: var(--warning); color: black; text-align: center; padding: 5px; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

    <header>
        <h1 id="page-title">Punto de Venta</h1>
    </header>
    <div id="editing-indicator" class="editing-mode-indicator">‚úèÔ∏è MODO EDICI√ìN ACTIVO</div>

    <div id="tab-sell" class="container active">
        <div class="card" style="border: 2px solid var(--primary);">
            
            <div class="flex-row" id="subtotal-view">
                <h4 style="margin:0;">Subtotal</h4>
                <p style="margin:0;">$<span id="cart-subtotal">0.00</span></p>
            </div>
            
            <div class="flex-row">
                <h4 style="margin:0;">Descuento Fijo ($)</h4>
                <input type="number" id="discount-fixed" oninput="updateCartUI()" value="0" min="0" style="width:40%; text-align:right; padding:5px; margin:0; font-size:1rem;">
            </div>

            <div class="flex-row" id="discount-amount-view">
                <h4 style="margin:0; color:var(--danger)">Monto Descontado</h4>
                <p style="margin:0; color:var(--danger)">$<span id="discount-amount">0.00</span></p>
            </div>

            <div class="flex-row" style="border-top: 1px dashed #ddd; padding-top:10px; margin-top:10px;">
                <h2 style="margin:0; color:var(--primary)">TOTAL FINAL</h2>
                <h2 style="margin:0; color:var(--primary)">$<span id="cart-total">0.00</span></h2>
            </div>
            
            <p id="cart-items-count" style="margin:5px 0 0 0; text-align:center; font-weight:bold;"></p>
            <button onclick="checkout()" class="btn-sell">Cobrar</button>
        </div>
        
        <h3>üõí Carrito Actual</h3>
        <div id="cart-details-list"></div>

        <h3>Cat√°logo</h3>
        <div id="sell-list"></div>
    </div>
    
    <div id="tab-deliveries" class="container">
        <div class="card">
            <h3>Agendar Nueva Entrega</h3>
            <div class="input-group">
                <input type="datetime-local" id="del-datetime">
            </div>
            <input type="text" id="del-client-name" placeholder="Nombre del Cliente (Requerido)">
            <input type="text" id="del-location" placeholder="Ubicaci√≥n de Entrega (Requerido)">
            <textarea id="del-items" placeholder="Art√≠culos a Entregar (ej. 1 Paquete B√°sico, 2 Redes Sociales)"></textarea>
            <button onclick="scheduleDelivery()" class="btn-schedule">üìÖ Guardar Entrega</button>
        </div>
        <h3>Pr√≥ximas Entregas</h3>
        <div id="deliveries-list"></div>
    </div>


    <div id="tab-inventory" class="container">
        <div class="card">
            <h3 id="form-title">Nuevo Producto</h3>
            <input type="text" id="inp-name" placeholder="Nombre (ej. Paquete B√°sico)">
            <div class="input-group">
                <input type="number" id="inp-price" placeholder="Precio Venta ($)">
                <input type="number" id="inp-cost" placeholder="Costo Inversi√≥n ($)">
            </div>
            <input type="number" id="inp-stock" placeholder="Cantidad Stock">
            
            <button onclick="addProduct()" id="btn-save" class="btn-add">üíæ Guardar Producto</button>
            <button onclick="updateProduct()" id="btn-update" class="btn-update">üîÑ Actualizar Producto</button>
            <button onclick="cancelEdit()" id="btn-cancel" class="btn-update" style="background:#ddd; color:#333; margin-top:5px;">Cancelar Edici√≥n</button>
        </div>
        <h3>Tus Productos</h3>
        <div id="inventory-list"></div>
    </div>

    <div id="tab-stats" class="container">
        <div class="stat-card stat-blue">
            <div class="stat-label">VENTAS TOTALES (Ingresos)</div>
            <div class="stat-number">$<span id="stat-revenue">0.00</span></div>
        </div>
        <div class="stat-card stat-red">
            <div class="stat-label">TOTAL INVERTIDO (En lo vendido)</div>
            <div class="stat-number">$<span id="stat-cost">0.00</span></div>
        </div>
        <div class="stat-card stat-green">
            <div class="stat-label">GANANCIA NETA (Utilidad)</div>
            <div class="stat-number">$<span id="stat-profit">0.00</span></div>
        </div>
        <div class="card">
            <h3>Valor del Inventario Actual</h3>
            <p>Dinero detenido en mercanc√≠a sin vender: <strong>$<span id="stat-stock-value">0.00</span></strong></p>
            <button onclick="resetStats()" style="background:none; color:red; font-size:0.8rem; margin-top:10px; text-decoration:underline;">Borrar historial de ventas</button>
        </div>
    </div>

    <nav>
        <button onclick="switchTab('sell')" id="nav-sell" class="active">
            <span>üõí</span>Vender
        </button>
        <button onclick="switchTab('deliveries')" id="nav-deliveries">
            <span>üöö</span>Entregas
        </button>
        <button onclick="switchTab('inventory')" id="nav-inventory">
            <span>üì¶</span>Stock
        </button>
        <button onclick="switchTab('stats')" id="nav-stats">
            <span>üìà</span>Finanzas
        </button>
    </nav>

    <script>
        // --- BASE DE DATOS LOCAL ---
        let products = JSON.parse(localStorage.getItem('myProducts')) || [];
        let salesHistory = JSON.parse(localStorage.getItem('mySales')) || [];
        let deliveries = JSON.parse(localStorage.getItem('myDeliveries')) || []; // NUEVA LISTA
        let cart = [];
        let editingIndex = -1; 

        function saveLocal() {
            localStorage.setItem('myProducts', JSON.stringify(products));
            localStorage.setItem('mySales', JSON.stringify(salesHistory));
            localStorage.setItem('myDeliveries', JSON.stringify(deliveries)); // GUARDAR ENTREGAS
            render();
        }

        // --- RENDERIZADO (DIBUJAR PANTALLA) ---
        function render() {
            renderInventoryList();
            renderDeliveries(); // NUEVO RENDERIZADO
            updateStatsUI();
            updateCartUI(); 
        }
        
        function renderInventoryList() {
            const sellList = document.getElementById('sell-list');
            const invList = document.getElementById('inventory-list');
            
            sellList.innerHTML = '';
            invList.innerHTML = '';

            products.forEach((p, i) => {
                // Lista para VENDER
                sellList.innerHTML += `
                    <div class="card flex-row">
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <p>Precio: $${p.price}</p>
                        </div>
                        <div style="text-align:right">
                            <div class="stock-badge" style="margin-bottom:5px;">Stock: ${p.stock}</div>
                            <button class="btn-add" style="margin:0; padding:5px 15px;" onclick="addToCart(${i})">‚ûï</button>
                        </div>
                    </div>
                `;

                // Lista para INVENTARIO (Administrar)
                invList.innerHTML += `
                    <div class="card flex-row">
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <p>Venta: $${p.price} | Costo: $${p.cost}</p>
                            <p style="color:${p.stock < 3 ? 'red' : 'green'}">Stock: ${p.stock}</p>
                        </div>
                        <div>
                            <button class="btn-icon" onclick="startEdit(${i})">‚úèÔ∏è</button>
                            <button class="btn-icon" style="color:red;" onclick="deleteProduct(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- L√ìGICA INVENTARIO ---
        function addProduct() {
            const name = document.getElementById('inp-name').value;
            const price = parseFloat(document.getElementById('inp-price').value);
            const cost = parseFloat(document.getElementById('inp-cost').value);
            const stock = parseInt(document.getElementById('inp-stock').value);

            if(name && !isNaN(price) && !isNaN(cost) && !isNaN(stock)) {
                products.push({ name, price, cost, stock });
                saveLocal();
                clearForm();
                alert('Producto creado');
            } else {
                alert('Completa todos los campos correctamente');
            }
        }

        function deleteProduct(i) {
            if(confirm('¬øEliminar este producto?')) {
                products.splice(i, 1);
                saveLocal();
            }
        }

        // --- L√ìGICA EDICI√ìN ---
        function startEdit(i) {
            editingIndex = i;
            const p = products[i];
            
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-price').value = p.price;
            document.getElementById('inp-cost').value = p.cost;
            document.getElementById('inp-stock').value = p.stock;

            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('btn-update').style.display = 'block';
            document.getElementById('btn-cancel').style.display = 'block';
            document.getElementById('form-title').innerText = 'Editando: ' + p.name;
            document.getElementById('editing-indicator').style.display = 'block';
            
            window.scrollTo(0,0);
        }

        function updateProduct() {
            if(editingIndex === -1) return;

            const name = document.getElementById('inp-name').value;
            const price = parseFloat(document.getElementById('inp-price').value);
            const cost = parseFloat(document.getElementById('inp-cost').value);
            const stock = parseInt(document.getElementById('inp-stock').value);

            if(name && !isNaN(price)) {
                products[editingIndex] = { name, price, cost, stock };
                saveLocal();
                clearForm();
                alert('Producto actualizado');
            }
        }

        function cancelEdit() {
            clearForm();
        }

        function clearForm() {
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-price').value = '';
            document.getElementById('inp-cost').value = '';
            document.getElementById('inp-stock').value = '';
            
            document.getElementById('btn-save').style.display = 'block';
            document.getElementById('btn-update').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('form-title').innerText = 'Nuevo Producto';
            document.getElementById('editing-indicator').style.display = 'none';
            editingIndex = -1;
        }

        // --- L√ìGICA VENTA ---
        function addToCart(productIndex) {
            if(products[productIndex].stock > 0) {
                // Clonamos el objeto y a√±adimos el √≠ndice original
                let item = { ...products[productIndex], originalIndex: productIndex }; 
                cart.push(item);
                products[productIndex].stock--; 
                updateCartUI();
                saveLocal(); 
            } else {
                alert('Sin stock');
            }
        }
        
        function removeFromCart(cartIndex) {
            if (cartIndex >= 0 && cartIndex < cart.length) {
                const itemToRemove = cart[cartIndex];
                const originalProductIndex = itemToRemove.originalIndex;

                products[originalProductIndex].stock++; 

                cart.splice(cartIndex, 1);
                
                saveLocal(); 
                updateCartUI();
            }
        }

        // --- L√ìGICA CARITO y DESCUENTO ---
        function updateCartUI() {
            let subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-subtotal').innerText = subtotal.toFixed(2);
            
            const discountFixedInput = document.getElementById('discount-fixed');
            let discountAmount = parseFloat(discountFixedInput.value) || 0;
            
            // Asegurar que el descuento no sea mayor que el subtotal
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
                discountFixedInput.value = subtotal.toFixed(2);
            }
            
            const finalTotal = subtotal - discountAmount;
            
            document.getElementById('discount-amount').innerText = discountAmount.toFixed(2);
            document.getElementById('cart-total').innerText = finalTotal.toFixed(2);
            document.getElementById('cart-items-count').innerText = `${cart.length} items`;

            // Renderizar los detalles del carrito
            const cartDetailsList = document.getElementById('cart-details-list');
            cartDetailsList.innerHTML = '';
            cart.forEach((item, i) => {
                cartDetailsList.innerHTML += `
                    <div class="item-card">
                        <div class="item-info">${item.name} ($${item.price.toFixed(2)})</div>
                        <button class="btn-remove" onclick="removeFromCart(${i})">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            });
        }

        function checkout() {
            if(cart.length === 0) return alert('Carrito vac√≠o');
            
            if(confirm('¬øConfirmar venta?')) {
                // Capturamos los valores finales
                const totalSale = parseFloat(document.getElementById('cart-total').innerText);
                const totalCostOfItems = cart.reduce((sum, item) => sum + item.cost, 0);
                const discountAmount = parseFloat(document.getElementById('discount-amount').innerText);
                const subtotal = cart.reduce((sum, item) => sum + item.price, 0);

                const saleRecord = {
                    date: new Date().toISOString(),
                    items: cart.map(item => ({name: item.name, price: item.price, cost: item.cost})),
                    subtotal: subtotal,
                    discount: discountAmount,
                    totalSale: totalSale, 
                    totalCost: totalCostOfItems 
                };
                
                salesHistory.push(saleRecord);
                
                // Resetear carrito
                cart = [];
                document.getElementById('discount-fixed').value = '0'; // Reset discount
                
                saveLocal(); 
                alert('¬°Venta registrada!');
                switchTab('stats'); 
            }
        }

        // --- L√ìGICA ENTREGAS (NUEVA) ---
        function scheduleDelivery() {
            const datetime = document.getElementById('del-datetime').value;
            const clientName = document.getElementById('del-client-name').value;
            const location = document.getElementById('del-location').value;
            const items = document.getElementById('del-items').value;

            if (!datetime || !clientName || !location || !items) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            deliveries.push({
                datetime,
                clientName,
                location,
                items,
                isCompleted: false,
                id: Date.now() // ID √∫nico para manipular la entrega
            });

            saveLocal();
            // Limpiar formulario
            document.getElementById('del-datetime').value = '';
            document.getElementById('del-client-name').value = '';
            document.getElementById('del-location').value = '';
            document.getElementById('del-items').value = '';
            
            alert('Entrega agendada con √©xito.');
            switchTab('deliveries');
        }

        function findDeliveryIndexById(id) {
            return deliveries.findIndex(d => d.id === id);
        }

        function deleteDelivery(id) {
            if(confirm('¬øEliminar esta entrega agendada?')) {
                const index = findDeliveryIndexById(id);
                if (index > -1) {
                    deliveries.splice(index, 1);
                    saveLocal();
                }
            }
        }

        function markDelivery(id) {
            const index = findDeliveryIndexById(id);
            if (index > -1) {
                deliveries[index].isCompleted = true;
                saveLocal();
            }
        }

        function unmarkDelivery(id) {
            const index = findDeliveryIndexById(id);
            if (index > -1) {
                deliveries[index].isCompleted = false;
                saveLocal();
            }
        }

        function renderDeliveries() {
            const list = document.getElementById('deliveries-list');
            list.innerHTML = '';
            
            // Ordenar por fecha/hora (m√°s cercano primero)
            const sortedDeliveries = [...deliveries].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            sortedDeliveries.forEach(d => {
                const dateTimeStr = d.datetime ? new Date(d.datetime).toLocaleString('es-MX', { 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                }) : 'Sin fecha';
                
                const cardClass = d.isCompleted ? 'delivery-card completed' : 'delivery-card pending';
                const statusText = d.isCompleted ? '‚úÖ Entregado' : '‚è≥ Pendiente';
                const btnAction = d.isCompleted ? `unmarkDelivery(${d.id})` : `markDelivery(${d.id})`;
                const btnText = d.isCompleted ? 'Desmarcar' : 'Completar';

                list.innerHTML += `
                    <div class="card ${cardClass}" style="border-left-color: ${d.isCompleted ? 'var(--success)' : 'var(--primary)'};">
                        <div class="flex-row" style="align-items:flex-start;">
                            <div style="flex-grow:1;">
                                <h4 style="margin:0 0 5px 0;">Cliente: ${d.clientName}</h4>
                                <p style="margin:0 0 5px 0; font-weight:bold; color:var(--primary);">${dateTimeStr}</p>
                                <p style="margin:0; font-size:0.9rem;">üìç **Ubicaci√≥n:** ${d.location}</p>
                                <p style="margin:5px 0 10px 0; font-size:0.9rem;">üì¶ **Art√≠culos:** ${d.items}</p>
                                <span class="stock-badge" style="background:${d.isCompleted ? '#dcfce7' : '#eff6ff'}; color:${d.isCompleted ? 'var(--success)' : 'var(--primary)'};">${statusText}</span>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <button class="btn-remove" style="background:none; color:var(--danger); margin-top:0;" onclick="deleteDelivery(${d.id})">üóëÔ∏è</button>
                                <button class="btn-icon" style="background:${d.isCompleted ? '#dcfce7' : '#e0f2f1'}; color:${d.isCompleted ? 'var(--success)' : 'var(--primary)'}; padding: 8px 10px; font-size: 0.8rem; font-weight:bold;" onclick="${btnAction}">${btnText}</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (deliveries.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666;">No hay entregas programadas.</p>';
            }
        }

        // --- L√ìGICA FINANZAS ---
        function updateStatsUI() {
            let totalRevenue = 0;
            let totalCostOfSold = 0;

            salesHistory.forEach(sale => {
                totalRevenue += sale.totalSale;
                totalCostOfSold += sale.totalCost;
            });

            let profit = totalRevenue - totalCostOfSold;
            
            let inventoryValue = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);

            document.getElementById('stat-revenue').innerText = totalRevenue.toFixed(2);
            document.getElementById('stat-cost').innerText = totalCostOfSold.toFixed(2);
            document.getElementById('stat-profit').innerText = profit.toFixed(2);
            document.getElementById('stat-stock-value').innerText = inventoryValue.toFixed(2);
        }

        function resetStats() {
            if(confirm('¬øDeseas BORRAR todo el historial de dinero? (El stock se mantiene)')) {
                salesHistory = [];
                saveLocal();
            }
        }

        // --- NAVEGACI√ìN ---
        function switchTab(tab) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            let titles = { 'sell': 'Punto de Venta', 'deliveries': 'Mis Entregas', 'inventory': 'Inventario', 'stats': 'Mis Finanzas' };
            document.getElementById('page-title').innerText = titles[tab];
        }

        // Iniciar
        render();
    </script>
</body>
</html>
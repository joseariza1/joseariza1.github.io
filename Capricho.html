<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cloud Pro - v7</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        [v-cloak] { display: none; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app" v-cloak>
        
        <div v-if="cargando" class="loading-overlay font-bold flex-col">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent mb-4"></div>
            Sincronizando...
        </div>

        <nav class="bg-indigo-800 text-white shadow-lg p-4 sticky top-0 z-50 flex justify-around">
            <button @click="vista = 'ventas'"><i class="bi bi-cart"></i> Ventas</button>
            <button @click="vista = 'agendados'"><i class="bi bi-calendar"></i> Agenda</button>
            <button @click="vista = 'stock'"><i class="bi bi-box"></i> Stock</button>
            <button @click="vista = 'reportes'"><i class="bi bi-graph-up"></i> Reportes</button>
        </nav>

        <main class="p-4 max-w-5xl mx-auto">
            
            <section v-if="vista === 'ventas'">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-6 border-l-8 border-indigo-500">
                    <div class="flex justify-between mb-4">
                        <h2 class="font-bold text-xl text-indigo-900">Carrito</h2>
                        <button v-if="carrito.length > 0" @click="abrirModalDescuento" class="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold">
                            <i class="bi bi-percent"></i> Aplicar Descuento
                        </button>
                    </div>

                    <div v-for="(item, i) in carrito" :key="i" class="flex justify-between items-center text-sm border-b py-2">
                        <span>{{ item.nombre }}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-bold">${{ item.precioVenta }}</span>
                            <button @click="quitarDelCarrito(i)" class="text-red-400"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>

                    <div class="mt-4 flex flex-col items-end">
                        <div v-if="descuentoAplicado > 0" class="text-red-500 text-xs font-bold">
                            Descuento: -${{ descuentoAplicado }}
                        </div>
                        <div class="text-3xl font-black">${{ totalConDescuento }}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button @click="finalizarVentaInmediata" :disabled="carrito.length === 0" class="bg-green-600 text-white p-3 rounded-xl font-bold disabled:opacity-30">Vender</button>
                        <button @click="mostrarModalAgenda = true" :disabled="carrito.length === 0" class="bg-indigo-600 text-white p-3 rounded-xl font-bold disabled:opacity-30">Agendar</button>
                    </div>
                </div>

                <input type="text" v-model="busqueda" placeholder="Buscar producto..." class="w-full p-4 rounded-xl mb-6 shadow-sm border-none focus:ring-2 focus:ring-indigo-400">

                <div class="grid-products">
                    <div v-for="p in productosFiltrados" @click="agregarAlCarrito(p)" 
                         :class="{'opacity-40': obtenerStockReal(p) <= 0}"
                         class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center cursor-pointer active:scale-95 transition">
                        <i v-if="p.esPaquete" class="bi bi-box-seam-fill text-purple-500 text-2xl"></i>
                        <i v-else class="bi bi-tag text-indigo-400 text-2xl"></i>
                        <h3 class="text-xs font-bold mt-2 h-8 overflow-hidden">{{ p.nombre }}</h3>
                        <p class="font-black text-lg">${{ p.precioVenta }}</p>
                        <p class="text-[10px] text-gray-500 font-bold uppercase">Stock: {{ obtenerStockReal(p) }}</p>
                    </div>
                </div>
            </section>

            <section v-if="vista === 'stock'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Inventario</h2>
                    <button @click="mostrarModalPaquete = true" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md">
                        <i class="bi bi-boxes"></i> Crear Paquete
                    </button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" v-model="nuevoProd.nombre" placeholder="Nombre" class="p-2 border rounded-lg col-span-2">
                        <input type="number" v-model="nuevoProd.costo" placeholder="Costo Unit" class="p-2 border rounded-lg">
                        <input type="number" v-model="nuevoProd.piezas" placeholder="Cantidad" class="p-2 border rounded-lg">
                        <input type="number" v-model="nuevoProd.precioVenta" placeholder="Precio Venta" class="p-2 border rounded-lg col-span-2 font-bold text-indigo-600 bg-indigo-50">
                    </div>
                    <button @click="guardarProducto" class="w-full mt-4 bg-indigo-600 text-white p-3 rounded-xl font-bold shadow-lg">Registrar Producto</button>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full text-left text-sm">
                        <tr class="bg-gray-100 text-[10px] uppercase text-gray-400">
                            <th class="p-3">Producto</th>
                            <th class="p-3">Stock</th>
                            <th class="p-3">Venta</th>
                            <th class="p-3">Acci칩n</th>
                        </tr>
                        <tr v-for="p in productos" class="border-b">
                            <td class="p-3 font-bold">{{ p.nombre }}</td>
                            <td class="p-3">{{ obtenerStockReal(p) }}</td>
                            <td class="p-3 font-bold text-green-600">${{ p.precioVenta }}</td>
                            <td class="p-3">
                                <button @click="eliminarProducto(p.id)" class="text-red-400"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    </table>
                </div>
            </section>

            <div v-if="mostrarModalPaquete" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                <div class="bg-white p-6 rounded-3xl w-full max-w-lg shadow-2xl">
                    <h2 class="text-lg font-bold mb-4 text-purple-700 underline">Configurar Paquete</h2>
                    <div class="space-y-4">
                        <input type="text" v-model="paqueteNuevo.nombre" placeholder="Nombre del Paquete (Ej: Combo Fiesta)" class="w-full p-3 border rounded-xl">
                        <input type="number" v-model="paqueteNuevo.precioVenta" placeholder="Precio Total del Paquete" class="w-full p-3 border rounded-xl font-bold text-purple-600">
                        
                        <p class="text-xs font-bold text-gray-400 uppercase">Selecciona los componentes:</p>
                        <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 border rounded-xl">
                            <div v-for="p in productos.filter(x => !x.esPaquete)" 
                                 @click="toggleProdEnPaquete(p)"
                                 :class="paqueteSeleccionados.includes(p.id) ? 'bg-purple-600 text-white' : 'bg-gray-100'"
                                 class="p-2 rounded-lg text-xs cursor-pointer transition text-center">
                                {{ p.nombre }}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button @click="guardarPaquete" class="flex-1 bg-purple-600 text-white p-3 rounded-xl font-bold">Crear Paquete</button>
                        <button @click="mostrarModalPaquete = false" class="bg-gray-100 p-3 rounded-xl">Cerrar</button>
                    </div>
                </div>
            </div>

            <div v-if="mostrarModalDescuento" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                <div class="bg-white p-6 rounded-3xl w-full max-w-xs shadow-2xl text-center">
                    <i class="bi bi-cash-coin text-4xl text-green-500"></i>
                    <h2 class="text-lg font-bold mt-2">Precio Final</h2>
                    <p class="text-xs text-gray-500 mb-4">Ingresa cu치nto vas a cobrar en total</p>
                    <input type="number" v-model="nuevoPrecioFinal" class="w-full p-4 border-2 border-green-400 rounded-2xl text-2xl font-black text-center mb-4">
                    <button @click="aplicarDescuento" class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold">Confirmar Precio</button>
                    <button @click="mostrarModalDescuento = false" class="mt-2 text-gray-400 text-sm">Cancelar</button>
                </div>
            </div>

            </main>
    </div>

    <script type="module">
         const FIREBASE_URL = "https://capricho-8db02-default-rtdb.firebaseio.com/"; 

        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    vista: 'ventas',
                    busqueda: '',
                    cargando: true,
                    productos: [],
                    ventasDia: [],
                    carrito: [],
                    nuevoProd: { nombre: '', costo: 0, piezas: 0, precioVenta: 0 },
                    // L칩gica de Paquetes
                    mostrarModalPaquete: false,
                    paqueteNuevo: { nombre: '', precioVenta: 0 },
                    paqueteSeleccionados: [],
                    // L칩gica de Descuento
                    mostrarModalDescuento: false,
                    nuevoPrecioFinal: 0,
                    descuentoAplicado: 0,
                    // Agenda
                    mostrarModalAgenda: false,
                    agenda: { cliente: '', fecha: '', lugar: '' }
                }
            },
            computed: {
                productosFiltrados() {
                    return this.productos.filter(p => p.nombre.toLowerCase().includes(this.busqueda.toLowerCase()));
                },
                totalSinDescuento() {
                    return this.carrito.reduce((acc, item) => acc + parseFloat(item.precioVenta), 0);
                },
                totalConDescuento() {
                    return Math.max(0, this.totalSinDescuento - this.descuentoAplicado);
                }
            },
            methods: {
                async persistir() {
                    try {
                        const data = { productos: this.productos, ventas: this.ventasDia };
                        await fetch(`${FIREBASE_URL}data.json`, { method: 'PUT', body: JSON.stringify(data) });
                    } catch (e) { console.error(e); }
                },
                async cargarDatos() {
                    try {
                        const res = await fetch(`${FIREBASE_URL}data.json`);
                        const data = await res.json();
                        if (data) {
                            this.productos = data.productos || [];
                            this.ventasDia = data.ventas || [];
                        }
                    } finally { this.cargando = false; }
                },
                obtenerStockReal(prod) {
                    if (!prod.esPaquete) return prod.piezas;
                    const stocks = prod.componentesIds.map(id => {
                        const comp = this.productos.find(p => p.id === id);
                        return comp ? comp.piezas : 0;
                    });
                    return stocks.length ? Math.min(...stocks) : 0;
                },
                toggleProdEnPaquete(prod) {
                    const idx = this.paqueteSeleccionados.indexOf(prod.id);
                    if (idx > -1) this.paqueteSeleccionados.splice(idx, 1);
                    else this.paqueteSeleccionados.push(prod.id);
                },
                guardarPaquete() {
                    if (!this.paqueteNuevo.nombre || this.paqueteSeleccionados.length === 0) return alert("Faltan datos");
                    this.productos.push({
                        id: Date.now(),
                        nombre: this.paqueteNuevo.nombre,
                        precioVenta: this.paqueteNuevo.precioVenta,
                        esPaquete: true,
                        componentesIds: [...this.paqueteSeleccionados]
                    });
                    this.mostrarModalPaquete = false;
                    this.paqueteSeleccionados = [];
                    this.paqueteNuevo = { nombre: '', precioVenta: 0 };
                    this.persistir();
                },
                abrirModalDescuento() {
                    this.nuevoPrecioFinal = this.totalConDescuento;
                    this.mostrarModalDescuento = true;
                },
                aplicarDescuento() {
                    const diff = this.totalSinDescuento - this.nuevoPrecioFinal;
                    this.descuentoAplicado = diff > 0 ? diff : 0;
                    this.mostrarModalDescuento = false;
                },
                agregarAlCarrito(prod) {
                    if (this.obtenerStockReal(prod) > 0) {
                        this.carrito.push({...prod});
                        if (prod.esPaquete) {
                            prod.componentesIds.forEach(id => {
                                const c = this.productos.find(p => p.id === id);
                                if (c) c.piezas--;
                            });
                        } else {
                            const p = this.productos.find(x => x.id === prod.id);
                            if (p) p.piezas--;
                        }
                    }
                },
                quitarDelCarrito(idx) {
                    const prod = this.carrito[idx];
                    if (prod.esPaquete) {
                        prod.componentesIds.forEach(id => {
                            const c = this.productos.find(p => p.id === id);
                            if (c) c.piezas++;
                        });
                    } else {
                        const p = this.productos.find(x => x.id === prod.id);
                        if (p) p.piezas++;
                    }
                    this.carrito.splice(idx, 1);
                    if (this.carrito.length === 0) this.descuentoAplicado = 0;
                },
                guardarProducto() {
                    this.productos.push({ ...this.nuevoProd, id: Date.now(), esPaquete: false });
                    this.persistir();
                    this.nuevoProd = { nombre: '', costo: 0, piezas: 0, precioVenta: 0 };
                },
                eliminarProducto(id) {
                    this.productos = this.productos.filter(p => p.id !== id);
                    this.persistir();
                },
                registrarVenta(tipo) {
                    this.ventasDia.push({
                        id: Date.now(),
                        total: this.totalConDescuento,
                        descuento: this.descuentoAplicado,
                        fechaReal: new Date(),
                        tipo,
                        productos: [...this.carrito],
                        cliente: this.agenda.cliente || 'Publico Gral',
                        completado: tipo === 'inmediata'
                    });
                    this.carrito = [];
                    this.descuentoAplicado = 0;
                    this.persistir();
                },
                finalizarVentaInmediata() { this.registrarVenta('inmediata'); }
            },
            mounted() {
                this.cargarDatos();
                setInterval(() => this.cargarDatos(), 15000); // Sincroniza cada 15 seg
            }
        }).mount('#app');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cloud Pro v6 - Paquetes Habilitados</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
        [v-cloak] { display: none; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 antialiased text-gray-800">
    <div id="app" v-cloak class="min-h-screen">
        
        <div v-if="cargando" class="loading-overlay">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-500 border-t-transparent mb-2"></div>
                <p>Sincronizando con la nube...</p>
            </div>
        </div>

        <nav class="bg-indigo-700 text-white shadow-lg p-4 sticky top-0 z-50 flex justify-around items-center text-sm md:text-base">
            <button @click="vista = 'ventas'" :class="{'underline font-bold': vista === 'ventas'}"><i class="bi bi-cash-stack"></i> Ventas</button>
            <button @click="vista = 'agendados'" :class="{'underline font-bold': vista === 'agendados'}"><i class="bi bi-calendar-check"></i> Agendados</button>
            <button @click="vista = 'stock'" :class="{'underline font-bold': vista === 'stock'}"><i class="bi bi-box-seam"></i> Stock</button>
            <button @click="vista = 'reportes'" :class="{'underline font-bold': vista === 'reportes'}"><i class="bi bi-graph-up"></i> Reportes</button>
        </nav>

        <main class="p-4 md:p-8 max-w-6xl mx-auto">
            
            <section v-if="vista === 'ventas'">
                <div class="bg-white p-6 rounded-2xl shadow-xl mb-8 border-t-4 border-indigo-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold"><i class="bi bi-cart4 text-indigo-600"></i> Cesta Actual</h2>
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">{{ carrito.length }} √≠tems</span>
                    </div>
                    
                    <div v-if="carrito.length === 0" class="text-gray-400 py-6 text-center border-2 border-dashed rounded-xl italic">Selecciona productos para vender</div>

                    <div class="flex flex-col gap-2 mb-6">
                        <div v-for="(item, index) in carrito" :key="index" class="bg-indigo-50 border border-indigo-100 px-4 py-3 rounded-xl flex items-center justify-between shadow-sm text-sm">
                            <div class="flex flex-col">
                                <span class="font-bold text-indigo-900">{{ item.nombre }}</span>
                                <span class="text-[10px] uppercase font-bold text-gray-400">Precio base: ${{ item.precioVenta }}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col items-end">
                                    <label class="text-[9px] font-black text-red-400 uppercase">Desc.</label>
                                    <input type="number" v-model.number="item.descuento" class="w-16 bg-white border border-red-200 rounded text-right px-1 font-bold text-red-500 outline-none" placeholder="0">
                                </div>
                                <div class="text-right min-w-[60px]">
                                    <span class="text-indigo-600 font-black text-lg">${{ item.precioVenta - (item.descuento || 0) }}</span>
                                </div>
                                <button @click="quitarDelCarrito(index)" class="text-red-500 hover:scale-110 transition"><i class="bi bi-trash3-fill"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-center border-t pt-4 gap-4">
                        <span class="text-3xl font-black text-gray-900">Total: ${{ totalVenta }}</span>
                        <div class="flex gap-2 w-full md:w-auto font-bold">
                            <button @click="finalizarVentaInmediata" :disabled="carrito.length === 0" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 disabled:opacity-50 transition">Vender Ya</button>
                            <button @click="mostrarModalAgenda = true" :disabled="carrito.length === 0" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 disabled:opacity-50 transition">Agendar</button>
                        </div>
                    </div>
                </div>

                <div class="mb-6 relative">
                    <i class="bi bi-search absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" v-model="busqueda" placeholder="Buscar por nombre..." class="w-full pl-12 pr-4 py-3 rounded-xl shadow-md border-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="grid-products">
                    <div v-for="prod in productosFiltrados" :key="prod.id" 
                         @click="agregarAlCarrito(prod)" 
                         :class="{'opacity-50 grayscale cursor-not-allowed': obtenerStockReal(prod) <= 0}"
                         class="bg-white p-4 rounded-2xl shadow hover:shadow-xl transition-all cursor-pointer border border-transparent hover:border-indigo-200 relative">
                        
                        <div v-if="prod.esPaquete" class="absolute top-2 right-2 bg-purple-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold">PACK</div>
                        
                        <div class="text-center">
                            <i v-if="prod.esPaquete" class="bi bi-boxes text-3xl text-purple-500 mb-2 block"></i>
                            <i v-else class="bi bi-tag text-3xl text-indigo-400 mb-2 block"></i>
                            <h3 class="font-bold text-sm h-10 overflow-hidden leading-tight mb-1">{{ prod.nombre }}</h3>
                            <p class="text-indigo-600 font-black text-xl">${{ prod.precioVenta }}</p>
                            <span :class="obtenerStockReal(prod) > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="text-[10px] px-2 py-0.5 rounded font-bold uppercase">
                                Stock: {{ obtenerStockReal(prod) }}
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="vista === 'agendados'">
                <h2 class="text-2xl font-black mb-6 text-indigo-800">üì¶ Pedidos por Entregar</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="v in ventasDia.filter(x => x.tipo === 'agendado' && !x.completado)" :key="v.id" class="bg-white p-5 rounded-2xl shadow border-l-8 border-blue-500">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-black text-lg uppercase text-blue-700">{{ v.cliente }}</h3>
                                <p class="text-xs text-gray-600 font-bold mt-1"><i class="bi bi-calendar-event"></i> {{ formatearFecha(v.fechaEntrega) }}</p>
                                <p class="text-xs text-gray-500"><i class="bi bi-geo-alt"></i> {{ v.lugar }}</p>
                            </div>
                            <button @click="eliminarPedidoAgendado(v.id)" class="text-red-400 hover:text-red-600 p-2 transition">
                                <i class="bi bi-trash3-fill text-xl"></i>
                            </button>
                        </div>
                        <div class="text-xs bg-gray-50 p-3 rounded-lg mb-4">
                            <div v-for="p in v.productos" class="flex justify-between border-b last:border-0 py-1">
                                <span>{{ p.nombre }}</span>
                                <span class="font-bold">${{ p.precioVenta - (p.descuento || 0) }}</span>
                            </div>
                        </div>
                        <button @click="v.completado = true; persistir()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition">Completar Entrega</button>
                    </div>
                </div>
            </section>

            <section v-if="vista === 'stock'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black italic">Inventario</h2>
                    <button @click="mostrarModalPaquete = true" class="bg-purple-600 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-purple-700 transition">
                        <i class="bi bi-plus-circle mr-1"></i> Armar Paquete
                    </button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-md mb-8 border-t-4 border-indigo-400">
                    <h3 class="font-bold text-xs uppercase tracking-widest text-gray-400 mb-4">{{ editandoId ? 'Modificar Producto' : 'Nuevo Producto' }}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold ml-2 text-gray-500 uppercase">Nombre</label>
                            <input type="text" v-model="nuevoProd.nombre" class="border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold ml-2 text-gray-500 uppercase">Costo Unitario ($)</label>
                            <input type="number" v-model="nuevoProd.costo" class="border p-3 rounded-xl outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold ml-2 text-gray-500 uppercase">Cantidad Inicial</label>
                            <input type="number" v-model="nuevoProd.piezas" class="border p-3 rounded-xl outline-none">
                        </div>
                    </div>
                    
                    <div v-if="nuevoProd.costo > 0" class="bg-indigo-50 p-4 rounded-xl flex flex-wrap gap-6 items-center">
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Sug. 50%</p><p class="font-black text-indigo-600">${{ (nuevoProd.costo * 1.5).toFixed(2) }}</p></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Sug. 70%</p><p class="font-black text-indigo-600">${{ (nuevoProd.costo * 1.7).toFixed(2) }}</p></div>
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-indigo-500 uppercase">Precio de Venta Final:</label>
                            <input type="number" v-model="nuevoProd.precioVenta" class="w-full border-2 border-indigo-300 p-2 rounded-lg font-black text-lg">
                        </div>
                    </div>
                    
                    <div class="mt-6 flex gap-2 font-bold">
                        <button @click="guardarProducto" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition">{{ editandoId ? 'Actualizar Producto' : 'Registrar en Inventario' }}</button>
                        <button v-if="editandoId" @click="cancelarEdicion" class="px-6 bg-gray-200 text-gray-600 py-3 rounded-xl hover:bg-gray-300 transition text-sm">Cancelar</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">
                                <th class="p-4 text-left">Producto</th>
                                <th class="p-4 text-center">Tipo</th>
                                <th class="p-4 text-center">Stock</th>
                                <th class="p-4 text-center">Venta</th>
                                <th class="p-4 text-right">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="p in productos" :key="p.id" class="hover:bg-gray-50 transition">
                                <td class="p-4 font-bold">{{ p.nombre }}</td>
                                <td class="p-4 text-center">
                                    <span v-if="p.esPaquete" class="text-[9px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-black">PAQUETE</span>
                                    <span v-else class="text-[9px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-black">INDIVIDUAL</span>
                                </td>
                                <td class="p-4 text-center font-black">
                                    <span :class="p.esPaquete ? 'text-purple-600' : ''">{{ obtenerStockReal(p) }}</span>
                                </td>
                                <td class="p-4 text-center font-black text-green-600">${{ p.precioVenta }}</td>
                                <td class="p-4 text-right">
                                    <button v-if="!p.esPaquete" @click="editarProducto(p)" class="text-blue-500 mx-2 hover:scale-110 transition"><i class="bi bi-pencil-square"></i></button>
                                    <button @click="eliminarProducto(p.id)" class="text-red-400 hover:text-red-600 transition"><i class="bi bi-trash-fill"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section v-if="vista === 'reportes'">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl shadow border-b-4 border-green-500">
                        <h4 class="text-gray-400 text-[10px] font-bold uppercase">Ingresos Totales</h4>
                        <p class="text-2xl font-black text-gray-900">${{ totalVendidoAcumulado }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow border-b-4 border-red-500">
                        <h4 class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Inversi√≥n Individual</h4>
                        <p class="text-2xl font-black text-red-600">${{ inversionTotalActual }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow border-b-4 border-indigo-500 text-center">
                        <h4 class="text-gray-400 text-[10px] font-bold uppercase">Ventas 7 D√≠as</h4>
                        <p class="text-2xl font-black text-gray-900">${{ totalSemanal }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow border-b-4 border-blue-400 text-center">
                        <h4 class="text-gray-400 text-[10px] font-bold uppercase">Pedidos Pendientes</h4>
                        <p class="text-2xl font-black text-blue-600">{{ ventasDia.filter(v => v.tipo === 'agendado' && !v.completado).length }}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                    <h3 class="font-bold text-gray-500 text-sm mb-4 uppercase tracking-wider">Flujo de Ventas (Semana)</h3>
                    <canvas id="graficaVentas" height="120"></canvas>
                </div>

                <div class="bg-white rounded-2xl shadow-md overflow-hidden">
                    <h3 class="p-5 font-bold text-gray-800 border-b">Detalle de Transacciones</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-50 text-gray-400 font-bold uppercase">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Cliente</th>
                                    <th class="p-4">Art√≠culos</th>
                                    <th class="p-4 text-right">Total</th>
                                    <th class="p-4 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 italic">
                                <tr v-for="v in ventasDia.slice().reverse()" :key="v.id" :class="{'bg-red-50 opacity-70': v.devuelta}">
                                    <td class="p-4 whitespace-nowrap">{{ formatearFecha(v.fechaReal) }}</td>
                                    <td class="p-4 uppercase font-bold text-indigo-600">
                                        {{ v.cliente }} 
                                        <span v-if="v.devuelta" class="block text-[8px] text-red-600 font-black">DEVUELTO</span>
                                    </td>
                                    <td class="p-4">
                                        <div v-for="p in v.productos" class="font-semibold text-gray-600 tracking-tight">‚Ä¢ {{ p.nombre }}</div>
                                    </td>
                                    <td class="p-4 text-right font-black text-sm" :class="v.devuelta ? 'text-gray-400 line-through' : 'text-gray-900'">
                                        ${{ v.total }}
                                    </td>
                                    <td class="p-4 text-center">
                                        <button v-if="!v.devuelta" @click="procesarDevolucion(v)" class="bg-red-100 text-red-600 px-3 py-1 rounded-full font-black text-[9px] hover:bg-red-600 hover:text-white transition">
                                            DEVOLUCI√ìN
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <div v-if="mostrarModalAgenda" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
            <div class="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl">
                <h2 class="text-xl font-bold mb-6 text-indigo-700 underline decoration-indigo-200">Datos para Agendar</h2>
                <div class="space-y-4 text-sm font-semibold">
                    <div>
                        <label class="text-xs text-gray-400 uppercase">Nombre del Cliente</label>
                        <input type="text" v-model="agenda.cliente" class="w-full border p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase">Fecha/Hora Entrega</label>
                        <input type="datetime-local" v-model="agenda.fecha" class="w-full border p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase">Lugar de Entrega</label>
                        <input type="text" v-model="agenda.lugar" class="w-full border p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                </div>
                <div class="flex gap-2 mt-8 font-black">
                    <button @click="finalizarVentaAgendada" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition">CONFIRMAR AGENDA</button>
                    <button @click="mostrarModalAgenda = false" class="flex-1 bg-gray-100 py-4 rounded-xl text-gray-400">CERRAR</button>
                </div>
            </div>
        </div>

        <div v-if="mostrarModalPaquete" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
            <div class="bg-white p-8 rounded-3xl w-full max-w-2xl shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-purple-700">Dise√±ador de Paquetes</h2>
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Paso 1: Elige componentes</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Nombre del Pack</label>
                        <input type="text" v-model="paqueteNuevo.nombre" placeholder="Ej: Kit Regalo 1" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Precio de Venta Pack</label>
                        <input type="number" v-model="paqueteNuevo.precioVenta" placeholder="0.00" class="w-full border-2 border-purple-200 bg-purple-50 p-3 rounded-xl outline-none font-bold text-purple-700">
                    </div>
                </div>

                <p class="text-[10px] font-black text-gray-400 uppercase mb-2">Selecciona los productos que incluye:</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-8 max-h-48 overflow-y-auto p-2 border rounded-2xl bg-gray-50">
                    <div v-for="p in productos.filter(x => !x.esPaquete)" 
                         @click="toggleProdEnPaquete(p.id)" 
                         :class="paqueteSeleccionadosIds.includes(p.id) ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-500 border-gray-100'"
                         class="border p-3 rounded-xl text-[11px] font-bold cursor-pointer text-center transition shadow-sm truncate">
                        {{ p.nombre }}
                    </div>
                </div>

                <div class="flex gap-3">
                    <button @click="guardarPaquete" :disabled="!paqueteNuevo.nombre || paqueteSeleccionadosIds.length === 0" class="flex-1 bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg disabled:opacity-30 hover:bg-purple-700 transition">CREAR PAQUETE DIN√ÅMICO</button>
                    <button @click="mostrarModalPaquete = false; paqueteSeleccionadosIds = []" class="px-8 bg-gray-100 text-gray-400 py-4 rounded-xl font-bold">CANCELAR</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        const FIREBASE_URL = "https://capricho-8db02-default-rtdb.firebaseio.com/"; 

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    vista: 'ventas',
                    busqueda: '',
                    productos: [], 
                    carrito: [],
                    ventasDia: [],
                    nuevoProd: { nombre: '', costo: 0, piezas: 0, precioVenta: 0 },
                    editandoId: null,
                    agenda: { cliente: '', fecha: '', lugar: '' },
                    mostrarModalAgenda: false,
                    mostrarModalPaquete: false,
                    paqueteNuevo: { nombre: '', precioVenta: null },
                    paqueteSeleccionadosIds: [],
                    chartInstance: null,
                    cargando: true
                }
            },
            watch: {
                vista(nueva) { if (nueva === 'reportes') this.$nextTick(() => this.generarGrafica()); }
            },
            computed: {
                productosFiltrados() {
                    return this.productos.filter(p => p.nombre.toLowerCase().includes(this.busqueda.toLowerCase()))
                                         .sort((a, b) => a.nombre.localeCompare(b.nombre));
                },
                // COMPUTED MODIFICADA: Calcula el total restando descuentos
                totalVenta() { return this.carrito.reduce((acc, item) => acc + (parseFloat(item.precioVenta) - (item.descuento || 0)), 0); },
                totalVendidoAcumulado() { return this.ventasDia.filter(v => !v.devuelta).reduce((acc, v) => acc + v.total, 0); },
                inversionTotalActual() { 
                    return this.productos.filter(p => !p.esPaquete).reduce((acc, p) => acc + ( (p.costo || 0) * (p.piezas || 0) ), 0); 
                },
                totalSemanal() {
                    const sieteDias = new Date(); sieteDias.setDate(sieteDias.getDate() - 7);
                    return this.ventasDia.filter(v => !v.devuelta && new Date(v.fechaReal) >= sieteDias).reduce((acc, v) => acc + v.total, 0);
                }
            },
            methods: {
                async persistir() {
                    try {
                        const data = { productos: this.productos, ventas: this.ventasDia };
                        await fetch(`${FIREBASE_URL}data.json`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                    } catch (e) { console.error("Error sincronizando:", e); }
                },

                async cargarDatos() {
                    try {
                        const res = await fetch(`${FIREBASE_URL}data.json`);
                        const data = await res.json();
                        if (data) {
                            this.productos = data.productos || [];
                            this.ventasDia = data.ventas || [];
                        }
                    } catch (e) { console.error("Error al cargar:", e); }
                    finally { this.cargando = false; }
                },

                formatearFecha(f) { return new Date(f).toLocaleString('es-MX', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}); },
                
                obtenerStockReal(prod) {
                    if (!prod.esPaquete) return prod.piezas;
                    if (!prod.componentesIds || prod.componentesIds.length === 0) return 0;
                    const stocks = prod.componentesIds.map(id => {
                        const comp = this.productos.find(p => p.id === id);
                        return comp ? comp.piezas : 0;
                    });
                    return Math.min(...stocks);
                },

                guardarProducto() {
                    if (this.editandoId) {
                        const idx = this.productos.findIndex(p => p.id === this.editandoId);
                        this.productos[idx] = { ...this.nuevoProd, id: this.editandoId, esPaquete: false };
                        this.editandoId = null;
                    } else {
                        this.productos.push({ ...this.nuevoProd, id: Date.now(), esPaquete: false });
                    }
                    this.persistir();
                    this.nuevoProd = { nombre: '', costo: 0, piezas: 0, precioVenta: 0 };
                },

                editarProducto(p) {
                    this.editandoId = p.id;
                    this.nuevoProd = { ...p };
                },

                cancelarEdicion() {
                    this.editandoId = null;
                    this.nuevoProd = { nombre: '', costo: 0, piezas: 0, precioVenta: 0 };
                },

                eliminarProducto(id) { 
                    if(confirm('¬øSeguro?')) { 
                        this.productos = this.productos.filter(p => p.id !== id); 
                        this.persistir(); 
                    } 
                },

                toggleProdEnPaquete(id) {
                    const index = this.paqueteSeleccionadosIds.indexOf(id);
                    if (index > -1) this.paqueteSeleccionadosIds.splice(index, 1);
                    else this.paqueteSeleccionadosIds.push(id);
                },

                guardarPaquete() {
                    const nuevoPack = {
                        id: Date.now(),
                        nombre: this.paqueteNuevo.nombre,
                        precioVenta: this.paqueteNuevo.precioVenta,
                        esPaquete: true,
                        componentesIds: [...this.paqueteSeleccionadosIds]
                    };
                    this.productos.push(nuevoPack);
                    this.persistir();
                    this.mostrarModalPaquete = false;
                    this.paqueteNuevo = { nombre: '', precioVenta: null };
                    this.paqueteSeleccionadosIds = [];
                },

                agregarAlCarrito(prod) {
                    if (this.obtenerStockReal(prod) > 0) { 
                        // Se agrega la propiedad descuento inicializada en 0
                        this.carrito.push({...prod, descuento: 0}); 
                        if (prod.esPaquete) {
                            prod.componentesIds.forEach(id => {
                                const comp = this.productos.find(p => p.id === id);
                                if (comp) comp.piezas--;
                            });
                        } else {
                            const p = this.productos.find(x => x.id === prod.id);
                            if (p) p.piezas--;
                        }
                    } else {
                        alert("Sin stock disponible");
                    }
                },

                reintegrarStock(item) {
                    if (item.esPaquete) {
                        item.componentesIds.forEach(id => {
                            const comp = this.productos.find(p => p.id === id);
                            if (comp) comp.piezas++;
                        });
                    } else {
                        const p = this.productos.find(x => x.id === item.id);
                        if (p) p.piezas++;
                    }
                },

                quitarDelCarrito(index) {
                    this.reintegrarStock(this.carrito[index]);
                    this.carrito.splice(index, 1);
                },

                registrarVenta(tipo) {
                    this.ventasDia.push({
                        id: Date.now(), total: this.totalVenta,
                        fechaReal: new Date(), fechaEntrega: this.agenda.fecha || new Date(),
                        tipo, cliente: this.agenda.cliente || 'Venta Mostrador',
                        lugar: this.agenda.lugar || 'Local', productos: [...this.carrito],
                        completado: tipo === 'inmediata', devuelta: false
                    });
                    this.carrito = [];
                    this.agenda = { cliente: '', fecha: '', lugar: '' };
                    this.persistir();
                },

                finalizarVentaInmediata() { this.registrarVenta('inmediata'); },
                finalizarVentaAgendada() {
                    if(!this.agenda.cliente || !this.agenda.fecha) return alert("Faltan datos");
                    this.registrarVenta('agendado');
                    this.mostrarModalAgenda = false;
                },

                procesarDevolucion(venta) {
                    if(confirm("¬øDevolver esta venta?")) {
                        venta.productos.forEach(item => this.reintegrarStock(item));
                        venta.devuelta = true;
                        this.persistir();
                    }
                },

                eliminarPedidoAgendado(id) {
                    if(confirm("¬øEliminar pedido?")) {
                        const idx = this.ventasDia.findIndex(v => v.id === id);
                        if (idx > -1) {
                            this.ventasDia[idx].productos.forEach(item => this.reintegrarStock(item));
                            this.ventasDia.splice(idx, 1);
                            this.persistir();
                        }
                    }
                },

                generarGrafica() {
                    const ctx = document.getElementById('graficaVentas').getContext('2d');
                    if(this.chartInstance) this.chartInstance.destroy();
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'],
                            datasets: [{
                                label: 'Ventas Semanales',
                                data: [0, 0, 0, 0, 0, 0, this.totalSemanal],
                                borderColor: '#6366f1',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(99, 102, 241, 0.1)'
                            }]
                        },
                        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                }
            },
            mounted() { this.cargarDatos(); }
        }).mount('#app');
    </script>
</body>
</html>
